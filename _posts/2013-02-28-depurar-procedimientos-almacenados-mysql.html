---
layout: post
title: Depurar procedimientos almacenados mysql
date: '2013-02-28T18:19:00.001+01:00'
author: Pere Vilas
tags:
- mysql
- strored procedure
- procedimiento almacenado
modified_time: '2013-02-28T18:19:07.834+01:00'
blogger_id: tag:blogger.com,1999:blog-9191328551308072706.post-5686540482874584915
blogger_orig_url: http://www.pvilas.com/2013/02/depurar-procedimientos-almacenados-mysql.html
---

Depurar procedimientos de bases de datos suele ser una tarea ingrata a no ser que tengamos alguna herramienta de desarrollo. Pero aún estas herramientas suelen modificar internamente el procedimiento para efectuar el depurado además de crear multitud de tablas intermedias para guardar el estado de las variables en cualquier punto de la ejecución.<br /><br />Si no te interesa este enfoque y sólo necesitas ir haciendo un log de lo que ocurre propongo el siguiente sistema que he ido mejorando a partir de diversas fuentes y experiencias.<br /><br />La idea se basa en la creación de una tabla temporal donde vamos realizando el log mediante una llamada al procedimiento doLog(msg).<br /><br />Primero creamos una tabla de configuración:<br /><br /><div style="border: 1px solid #DDD; padding: 1em 0.75em;"><code>CREATE TABLE `internal_config` (<br />  `debug` tinyint(4) NOT NULL DEFAULT '1'<br />) ENGINE=MyISAM DEFAULT CHARSET=utf8;<br /> <br /> insert into internal_config(debug) values(0);<br /></code></div><br />Que nos servirá para activar/desactivar el debug con:<br /><br /><div style="border: 1px solid #DDD; padding: 1em 0.75em;"><code>update internal_config set debug=true;<br /></code></div><br />El procedimiento que crea la tabla temporal es:<br /><br /><div style="border: 1px solid #DDD; padding: 1em 0.75em;"><code> CREATE PROCEDURE `setupTmpLog`()<br />BEGIN<br />&nbsp;CREATE TEMPORARY TABLE IF NOT EXISTS tmplog(<br />&nbsp; &nbsp;lin integer NOT NULL AUTO_INCREMENT primary key,<br />&nbsp; &nbsp;msg VARCHAR(512)<br />&nbsp;) ENGINE = MEMORY;<br />END<br /></code></div><br />y el que escribe el log: <br /><br /><div style="border: 1px solid #DDD; padding: 1em 0.75em;"><code> CREATE PROCEDURE `doLog`(IN logMsg VARCHAR(512))<br />BEGIN<br />&nbsp;declare do_debug bool default false;<br />&nbsp;DECLARE CONTINUE HANDLER FOR NOT FOUND SET do_debug=false;<br />&nbsp;DECLARE CONTINUE HANDLER FOR 1146 -- Table not found<br />&nbsp; BEGIN<br />&nbsp; &nbsp; CALL setupTmpLog(); <br />&nbsp; &nbsp; INSERT INTO tmplog(msg) VALUES ('resetup tmp table');<br />&nbsp; &nbsp; INSERT INTO tmplog(msg) VALUES (logMsg);<br />&nbsp; END;<br /><br />&nbsp;select debug from internal_config limit 1 into do_debug;<br /><br />&nbsp;-- escribimos en el log solo si debug esta activado<br />&nbsp;if (do_debug) then<br />&nbsp; &nbsp;INSERT INTO tmplog(msg) VALUES (logMsg);<br />&nbsp;end if;<br />END<br /></code></div><br />y finalmente, un procedimiento que nos muestra el log (con el último mensaje primero) y después borra la tabla:<br /><br /><div style="border: 1px solid #DDD; padding: 1em 0.75em;"><code> CREATE PROCEDURE `view_log`()<br />BEGIN<br />&nbsp; DECLARE CONTINUE HANDLER FOR 1146 -- Table not found<br />&nbsp; &nbsp;BEGIN<br />&nbsp; &nbsp; CALL setupTmpLog();<br />&nbsp; &nbsp;end;<br /><br />&nbsp; &nbsp;select msg from tmplog order by lin desc;<br /><br />&nbsp; &nbsp;drop table tmplog;<br />END<br /></code></div><br />Ya lo tenemos todo, para ir logeando en nuestros procedimientos sólo tenemos que llamar a doLog así:  <br /><br /><div style="border: 1px solid #DDD; padding: 1em 0.75em;"><code>call doLog(concat("Hola", " que ", " tal " ));<br /></code></div><br />Y cuando queramos ver (y limpiar) el log hacemos: <br /><br /><div style="border: 1px solid #DDD; padding: 1em 0.75em;"><code>call view_log();<br /></code></div><br />Espero que os sirva. Good Luck ;-)<br /><br /><br /><b><span style="font-size: x-small;">Fuentes:</span></b><br /><a href="http://www.drdobbs.com/database/debugging-mysql-stored-procedures/218100564?pgno=1"><span style="font-size: x-small;">http://www.drdobbs.com/database/debugging-mysql-stored-procedures/218100564?pgno=1</span></a>