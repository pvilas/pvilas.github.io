---
layout: post
title: Django filtro de query usando un string
date: '2013-07-23T17:47:00.000+02:00'
author: Pere Vilas
tags:
- django
modified_time: '2013-07-23T18:18:28.735+02:00'
blogger_id: tag:blogger.com,1999:blog-9191328551308072706.post-5397465626248649547
blogger_orig_url: http://www.pvilas.com/2013/07/django-filtro-de-query-usando-un-string.html
---

Es común que queramos pasar directamente un string al filtro de una consulta, por ejemplo, desde una url. Dado que el parámetro de filter es un diccionario, lo podemos hacer mediante el operador de desempaquetado de diccionarios **.<br /><br />Recordemos que para desempaquetar una lista usamos el operador * y para desempaquetar un diccionario el **:<br /><br /><h4>Ejemplo de *</h4><div><br /></div><code>&gt;&gt;&gt; pepe=(1,10,)<br />&gt;&gt;&gt; range(pepe)<br />Traceback (most recent call last):<br />File "", line 1, in<br />TypeError: range() integer end argument expected, got tuple.<br />&gt;&gt;&gt; range(*pepe)<br />[1, 2, 3, 4, 5, 6, 7, 8, 9]</code><br /><h4></h4><h4></h4><h4>Ejemplo de **</h4><br /><br /><code>&gt;&gt;&gt; pepe={ "venus" : "blanco", "tierra": "azul", "marte": "rojo" }<br />&gt;&gt;&gt; '{tierra}'.format(pepe)<br />Traceback (most recent call last):<br />File "", line 1, in <br />KeyError: 'tierra'<br />&gt;&gt;&gt; '{tierra}'.format(**pepe)<br />'azul'<br />&gt;&gt;&gt;</code><br /><br />En ambos ejemplos observamos que al usar * o ** pasamos con el tipo correcto. Pero ¿Cómo aprovecharlo para pasar directamente un filtro a la consulta?. Yo lo hago de la siguiente forma:<br /><div><code><br /><br /># un string<br />filtro="nacionalidad__exact@ESP"<br /># lo parseamos en clave-valor<br />f=filtro.split("@")<br /># pasamos como diccionario<br />p=Persona.objects.filter(**{f[0]:f[1]})<br /># el efecto es el mismo que hacer<br />p=Persona.objects.filter(nacionalidad__exact='ESP')</code><br />Y ahora veamos cómo implementarlo.<br /><br />En la página web:<br /><br /><code>$('a.pais').click(function() { <br />&nbsp; &nbsp;var pais=$(this).attr("pais");<br />&nbsp; &nbsp;$('#{{ "{{" }}entidad}}').load("?filtro="+escape('nacionalidad__exact@'+pais)+"&amp;type=ajax");<br />});</code><br /><br />Notemos que en la url pasamos,<br /><div><ol><li>Un interrogante: Hará un get sobre la página actual.</li><li>Un nombre de parámetro (filtro). Si queremos añadir más parámetros los separamos con &amp;</li><li>El valor del parametro poniendo un igual después del nombre, por ejemplo, <code>&nbsp;filtro=nacionalidad__exact@ESP</code>&nbsp;</li></ol></div><div>En la parte del servidor lo que hacemos es procesar directamente el filtro pasando de string a diccionario así:</div><div><br /></div><code><br />def get_filtro( self, request):<br />&nbsp;&nbsp;""" aplica el filtro y devuelve el modelo filtrado """<br />&nbsp;&nbsp; filtro=request.GET.get('filtro', False)<br />&nbsp;&nbsp; if filtro:<br />     &nbsp;&nbsp;try:<br />&nbsp;&nbsp;&nbsp;&nbsp; f=filtro.split('@') <br />&nbsp;&nbsp;&nbsp;&nbsp; return Persona.objects.filter(**{f[0]:f[1]})<br />&nbsp;&nbsp; except Exception, e:<br /> &nbsp;&nbsp;&nbsp;&nbsp;logger.error('desempaquetando filtro '+str(e))<br /><br />&nbsp;&nbsp; return Persona.objects.all()</code><br /><br /><div>La ventaja de este método es que es muy sencillo crear toda clase de filtros directamente en la página web teniendo un solo código que los gestiona en el servidor.&nbsp;</div><div><br /></div><div>Una última puntualización: Si no todos los usuarios pueden ver todo el modelo i.e. ver todas las personas <code>Persona.objects.all()</code> hay que ir con cuidado ya que es muy sencillo manipular a mano la url para que nos devuelva cualquier registro. Por ejemplo:</div><div><br /></div><code>?filtro=moroso__exact@1</code><div><br /></div><div>Nos devolvería todos los morosos ;-)</div><div><br /></div><div><br /></div><div><br /></div></div>