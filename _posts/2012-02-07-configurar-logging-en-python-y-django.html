---           
layout: post
title: Configurar logging en python y django con yaml
date: 2012-02-07 18:34:33 UTC
updated: 2012-02-07 18:34:33 UTC
comments: false
categories: django logging python
---

Os paso el esquema de logging que utilizo en mis aplicaciones por si os puede servir de ayuda. Lo he ido montando a partir de diversas fuentes y experiencias.<br /><br />Un punto importante es dejar el fichero de configuración del logging fuera del programa para independizar mejor el sistema de logging de la aplicación.<br /><br />Este puede ser un ejemplo del fichero de configuración en yaml (logger.conf):<br /><br /><div style="background-color: lightgrey;"><code></code><br /><code>version: 1</code><br /><code>formatters:</code><br /><code>&nbsp; brief:</code><br /><code>&nbsp; &nbsp; format: '%(name)s - %(levelname)s - %(message)s'</code><br /><code>&nbsp; simple:</code><br /><code>&nbsp; &nbsp; format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'</code><br /><code>&nbsp; detailed:</code><br /><code>&nbsp; &nbsp; format: '%(asctime)s %(module)-17s line:%(lineno)-4d %(levelname)-8s %(message)s'</code><br /><code>&nbsp; email:</code><br /><code>&nbsp; &nbsp; format: 'Timestamp: %(asctime)s\nModule: %(module)s\n Line: %(lineno)d\nMessage: %(message)s'</code><br /><code>handlers:</code><br /><code>&nbsp; console:</code><br /><code>&nbsp; &nbsp; class: logging.StreamHandler</code><br /><code>&nbsp; &nbsp; level: DEBUG</code><br /><code>&nbsp; &nbsp; formatter: brief</code><br /><code>&nbsp; &nbsp; stream: ext://sys.stdout</code><br /><code>&nbsp; file:</code><br /><code>&nbsp; &nbsp; class: logging.handlers.RotatingFileHandler</code><br /><code>&nbsp; &nbsp; level: INFO</code><br /><code>&nbsp; &nbsp; formatter: detailed</code><br /><code>&nbsp; &nbsp; filename: app.log</code><br /><code>&nbsp; &nbsp; mode: a</code><br /><code>&nbsp; &nbsp; maxBytes: 10485760</code><br /><code>&nbsp; &nbsp; backupCount: 5</code><br /><code>&nbsp; smtp:</code><br /><code>&nbsp; &nbsp; class: logging.handlers.SMTPHandler</code><br /><code>&nbsp; &nbsp; level: ERROR</code><br /><code>&nbsp; &nbsp; formatter: email</code><br /><code>&nbsp; &nbsp; mailhost: smtp.xxxxx.es</code><br /><code>&nbsp; &nbsp; fromaddr: yyy@xxxx.es</code><br /><code>&nbsp; &nbsp; toaddrs: &nbsp;yyyy@xxxx.es</code><br /><code>&nbsp; &nbsp; subject: &nbsp;Error en aplicacion XX</code><br /><code>root:</code><br /><code>&nbsp; level: DEBUG</code><br /><code>&nbsp; handlers: [console]</code></div><code><br /></code>Se observan los formateadores de los mensajes y los handlers para la cónsola, fichero y correo. Por defecto el logging sale por cónsola, si queremos que los errores salgan por email handlers de root sería [console, smtp], para fichero que rotara cada maxBytes [file], etc... Realmente cómodo.<br /><br />Para cargar la configuración, primero parseamos el yaml (PyYAML) y luego lo enviamos a dictConfig, que realiza la configuración así:<br /><br /><code> </code><br /><div style="background-color: lightgrey;"><code>import yaml<br />import logging</code><br /><code><br />#nos aseguramos de que dictConfig esté presente (python 2.7), sino, lo cargamos de la libreria de django&nbsp;</code><br /><code><br /></code><br /><code>try:&nbsp;</code><br /><code>&nbsp; &nbsp; from logging.config import dictConfig&nbsp;</code><br /><code>except ImportError:&nbsp;</code><br /><code>&nbsp; &nbsp; from django.utils.dictconfig import dictConfig <br /><br /># Cargamos la configuracion del fichero, la parseamos y la enviamos a dictConf<br />try:<br />&nbsp; &nbsp; logging.config.dictConfig(yaml.load(file('logger.conf','r')))<br />except Exception, e:<br />&nbsp; &nbsp; print "Error configurating logger ", str(e)<br /></code></div><br />Ahora ya podemos el usar el sistema. En general, es conveniente nombrar cada logger con el nombre de su módulo para que cuando haya muchos mensajes sepamos cuál los está enviando, para ello podemos usar el valor de __name__, así:<br /><br /><div style="background-color: lightgrey;"><code>logger=logging.getLogger(__name__) # __name__ contiene el nombre del modulo<br />logger.debug("blah blah")</code></div><br />Si queremos que cada clase tenga su logger privado, tenemos que tomar una pequeña precaución para evitar un error si otros usan una librería nuestra con otro sistema de handles,<br /><br />Declaramos una clase "nula":<br /><br /><div style="background-color: lightgrey;"><code>class Nullhandler(logging.Handler):<br />&nbsp; &nbsp;def emit(self, record):<br />&nbsp; &nbsp;&nbsp; &nbsp;pass<br /></code></div><br />y ahora, en la clase hacemos<br /><br /><div style="background-color: lightgrey;"><code>class Clase():<br />&nbsp; &nbsp;def __init__(self):<br />&nbsp; &nbsp;&nbsp; &nbsp;self.__logger=logging.getLogger(__name__)<br />&nbsp; &nbsp;&nbsp; &nbsp;self.__logger.addHandler(NullHandler())<br />&nbsp; &nbsp;&nbsp; &nbsp;self.__logger.debug("clase iniciada")<br /></code></div><br />Como veis es un tema un poco denso pero que una vez bien configurado nos será imprescindible para trazar correctamente las aplicaciones. Espero que os haya ayudado.