---           
layout: post
title: Django Guardar imágenes (o blobs) desde la red
date: 2011-03-03 18:21:29 UTC
updated: 2011-12-27 18:21:29 UTC
comments: false
categories: django
---

Debido a las consultas amplío el post anterior para aclarar un poco el proceso suponiendo que bajamos las imágenes desde un servidor sFTP, sólo hay que cambiar los parámetros de pycurl para operar con http, https, etc...<br /><br />Primero bajamos la imagen a memoria con algún gestor (pycurl por ejemplo o urllib) y guardarlo en un cStringIO:<br /><br /><code><br />import pycurl, cStringIO<br /><br />buf = cStringIO.StringIO() <br />url=('ftps://%s:990/%s' % (ip, fichero))<br />privatekey = '/home/sss/.ssh/id_rsa'<br />options = {<br />  pycurl.USERPWD: 'xxxxx:xxxx',<br />  pycurl.SSLKEYPASSWD: 'adfasdfasdfas',<br />  pycurl.SSH_PRIVATE_KEYFILE: privatekey,<br />  pycurl.SSH_PUBLIC_KEYFILE: privatekey + '.pub',<br />  #pycurl.WRITEDATA: open('/dev/null', 'wb'),<br />  pycurl.VERBOSE: 1,<br />  pycurl.URL: url,<br />  pycurl.HEADER: 1,<br />  pycurl.NOBODY: 1,<br />  pycurl.WRITEFUNCTION: buf.write,<br />  pycurl.NOPROGRESS: 1,<br />  pycurl.SSL_VERIFYPEER: 0,<br />  pycurl.SSL_VERIFYHOST: 0,<br />}<br /> <br />gestor = pycurl.Curl()<br />try:<br />for (k, v) in options.items():<br />  print k, v<br />  gestor.setopt(k, v)<br />except Exception, msg:<br />  logging.info('Error setopt %s' % msg)<br /><br />gestor.perform()<br /><br /></code><br /><br />Ahora ya tenemos la imagen en memoria (buf), vamos a grabarla (django la graba en disco y en la db solo se guarda el path), el único problema es que ImageField espera un campo file, pero lo solucionaremos con un workaround:<br /><br />En tu modelo pones:<br /><code><br />class Persona(models.Model):<br /> .....<br /> imagen=models.ImageField(upload_to=settings.PATH_FOTOS_CLIENTES, blank=True)<br /></code><br /><br />Donde settings.PATH_FOTOS_CLIENTES apunta a la ruta que cuelga de la ruta que tengas en settings.MEDIA_ROOT y tiene el formato siguiente o similar (en settings.py):<br /><br /><code><br />PATH_FOTOS_CLIENTES='clientes/%Y/%m/%d'<br /></code><br /><br />Ahora tenemos que pasar de la imagen que tienes cargada en memoria a un stream tipo 'file' para que pueda ser guardado por el modelo:<br /><br /><code><br />from django.core.files.uploadedfile import SimpleUploadedFile<br /><br />foto = SimpleUploadedFile('imagencliente.jpg',<br />         buf.getvalue(),<br />         "image/jpeg")<br /></code><br /><br />y ya salvamos:<br /><code><br />p=Persona( imagen=foto )<br />p.save()<br /></code><br /><br />Comentad si os surge alguna duda.<br />Saludos,<br />Pere Vilás.