---
layout: post
title: Creación de VLANs en routers Mikrotik. Traducción del original de Butch Evans.
date: '2014-09-24T02:00:00.011+02:00'
author: Pere Vilas
tags:
- VLANs
- VLAN
- mikrotik
modified_time: '2014-09-24T10:57:02.053+02:00'
blogger_id: tag:blogger.com,1999:blog-9191328551308072706.post-1634654666098759515
blogger_orig_url: http://www.pvilas.com/2014/09/creacion-de-vlans-en-routers-mikrotik.html
---

<p>Esta entrada es una traducción del artículo “<a href="http://blog.butchevans.com/2010/02/to-tag-or-not-to-tag-that-is-the-question/">To tag or not to tag…that is the question!</a>” de <a href="http://blog.butchevans.com/">Butch Evans</a>, publicado en su blog el 24 de febrero de 2010.</p> <p>Hay una cuestión muy solicitada de cómo los routers Mikrotik tratan el tráfico de VLAN. </p> <p>Déjenme empezar por el concepto más simple pero que es un buen fundamento para el resto del artículo:</p> <blockquote>  <p>Cuando se crea un interface VLAN, a todos los efectos el router se cree que tiene un nuevo interface físico.</p></blockquote> <p>Examinemos esta red: <br><img src="https://dl.dropboxusercontent.com/u/70868298/Vlan1.png" alt="vlan" title=""></p> <p>Cuando el router tiene que dirigir tráfico, lo hace basado en la ip asignada a cada interface. Por ejemplo, en la imagen,  todo el tráfico dirigido a la red 10.10.10.0/24 es dirigido al puerto ether1. Esto lo hace consultando su tabla de rutas.</p> <hr> <p>Vamos a ver otro ejemplo: <br><img src="https://dl.dropboxusercontent.com/u/70868298/vlan_iface1.png" alt="vlan-tagged" title=""> <br>De forma similar a la primera red, cuando el MT necesita comunicarse con la red 10.10.10.0/24, consulta su tabla de rutas. En este caso, el interface 10.10.10.1/24 es un interface VLAN que puede crearse con el siguiente código:</p> <pre class="prettyprint"><code class=" hljs oxygene">/<span class="hljs-keyword">interface</span> vlan <span class="hljs-keyword">add</span> name=vlan_1_e1 <span class="hljs-keyword">interface</span>=ether1 vlan-id=<span class="hljs-number">1</span><br />/ip address <span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=vlan_1_e1 address=<span class="hljs-number">10.10</span>.<span class="hljs-number">10.1</span>/<span class="hljs-number">24</span></code></pre> <p>La primera línea crea un interface vlan con un nombre descriptivo apropiado, <strong>asocia la vlan al puerto FÍSICO ether1</strong> y configura la vlan-id (el tag) como “1”. </p> <p>La segunda línea añade una dirección ip al interface vlan.</p> <blockquote>  <p>Cualquier tráfico destinado a la red 10.10.10.0/24 abandonará el router por este interface y, ya que lo hace por un interface vlan, este tráfico <strong>va ha ser marcado</strong> con la vlan-id 1. </p></blockquote> <p>Así como vamos a ir examinando otros tipos de configuraciones posibles, pensar siempre que lo único que hace que un paquete abandone el router con el tag de la vlan o no, es simplemente esto: <strong>Cada vez que un paquete abandona el router POR UN INTERFAZ VLAN, será marcado con la vlan</strong>. No es más complicado que esto.</p> <hr> <p>Vamos a considerar otra red: <br><img src="https://dl.dropboxusercontent.com/u/70868298/vlan_iface2.png" alt="vlan-iface2" title=""> <br>Esta red trabaja de forma muy similar a las anteriores. Podemos configurarla con este fragmento:</p>   <pre class="prettyprint"><code class=" hljs oxygene">/<span class="hljs-keyword">interface</span> vlan<br /><span class="hljs-keyword">add</span> name=vlan_1_e1 <span class="hljs-keyword">interface</span>=ether1 vlan-id=<span class="hljs-number">1</span><br /><span class="hljs-keyword">add</span> name=vlan_2_e1 <span class="hljs-keyword">interface</span>=ether1 vlan-id=<span class="hljs-number">2</span><br />/ip address<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=vlan_1_e1 address=<span class="hljs-number">10.10</span>.<span class="hljs-number">10.1</span>/<span class="hljs-number">24</span><br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=vlan_2_e1 address=<span class="hljs-number">10.10</span>.<span class="hljs-number">11.1</span>/<span class="hljs-number">24</span></code></pre> <p>En esta configuración, tenemos 2 vlans asociadas al interface físico ether1. El tráfico destinado a la red 10.10.10.0/24 abandonará el router por en interface <em>vlan_1_e1</em> y será marcado con el vlan-id “1”. De la misma forma, el tráfico destinado a la red 10.10.11.0/24 abandonará el router por el interface <em>vlan_2_e1</em> y será marcado con la vlan-id “2”. Si esto no queda claro, estudia la configuración de la imagen y debería quedarlo. Una nota adicional acerca de esta configuración es que cualquier dispositivo conectado al puerto FÍSICO ether1 debe ser configurado poder tratar el tag vlan para poder “ver” las direcciones 10.10.11.1 y 10.10.10.1.</p> <p>Hasta este punto, hemos discutido vlans que son usadas como interfaces <em>ENRUTADOS</em>.  </p> <p>Vamos a ver ahora un par de escenarios con puentes (bridged). Recuérdese que un dispositivo con RouterOS que tiene interfaces configuradas como bridge es transparente a la red. Démos una mirada a la siguiente configuración:</p>   <pre class="prettyprint"><code class=" hljs oxygene">/<span class="hljs-keyword">interface</span> bridge<br /><span class="hljs-keyword">add</span> name=bridge1<br />/<span class="hljs-keyword">interface</span> bridge port<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=ether1 bridge=bridge1<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=ether2 bridge=bridge1<br />/ip address<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=bridge1 address=<span class="hljs-number">10.10</span>.<span class="hljs-number">10.1</span>/<span class="hljs-number">24</span></code></pre> <p>Con este código hemos creado un bridge y le hemos añadido los interfaces ether1 y ether2. Con esta configuración, cualquier tráfico que entre al router por el <strong>puerto</strong> ether1 será pasado al interface ether <em>SIN TOCARSE</em>. Esto significa que el tráfico entrante tageado, seguirá tageado en cualquier dirección. La ip que hemos añadido será alcanzable en la red pero <em>SÓLO</em> cuando los paquetes vayan <em>SIN MARCAR</em>. El router es transparente en la red pero si la red en la que está conectado tiene tráfico con tags de vlan, el router no será alcanzable en la red.</p> <p>Vamos a asumir que la red del ejemplo usa vlan-id=1 para todos los paquetes. Si queremos manejar el router desde esta red, tenemos que crear un interface vlan con el bridge como interface maestro de esta forma:</p>   <pre class="prettyprint"><code class=" hljs oxygene">/<span class="hljs-keyword">interface</span> bridge<br /><span class="hljs-keyword">add</span> name=bridge1<br />/<span class="hljs-keyword">interface</span> bridge port<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=ether1 bridge=bridge1<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=ether2 bridge=bridge1<br />/<span class="hljs-keyword">interface</span> vlan<br /><span class="hljs-keyword">add</span> name=vlan_1_b1 <span class="hljs-keyword">interface</span>=bridge1 vlan-id=<span class="hljs-number">1</span><br />/ip address<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=vlan_1_b1 address=<span class="hljs-number">10.10</span>.<span class="hljs-number">10.1</span>/<span class="hljs-number">24</span></code></pre> <p>Esta configuración causará que el router deje pasar sin tocar todo el tráfico a través del bridge, pero incluye al propio router en la vlan <code>add name=vlan_1_b1 interface=bridge1</code> <strong>vlan-id=1</strong>, así que el router será manejable desde esa vlan.</p> <hr> <p>Ahora veremos otro escenario común: <br><img src="https://dl.dropboxusercontent.com/u/70868298/multiple_vlan.png" alt="vlan-tag-untag" title=""> <br>En esta situación, tenemos múltiples vlans que deben pasar a través del router. Podemos conseguirlo simplemente enlazando con un bridge ether1 y ether2, sin embargo, hay una solución más elegante si por alguna razón no deseas enlazar los dos puertos ethernet. Esta es la configuración (la explicación va seguida):</p> <pre class="prettyprint"><code class=" hljs oxygene">/<span class="hljs-keyword">interface</span> bridge<br /><span class="hljs-keyword">add</span> name=bridge_vlan1<br /><span class="hljs-keyword">add</span> name=bridge_vlan2<br />/<span class="hljs-keyword">interface</span> vlan<br /><span class="hljs-keyword">add</span> name=vlan_1_e1 <span class="hljs-keyword">interface</span>=ether1 vlan-id=<span class="hljs-number">1</span><br /><span class="hljs-keyword">add</span> name=vlan_2_e1 <span class="hljs-keyword">interface</span>=ether1 vlan-id=<span class="hljs-number">2</span><br /><span class="hljs-keyword">add</span> name=vlan_1_e2 <span class="hljs-keyword">interface</span>=ether2 vlan-id=<span class="hljs-number">1</span><br /><span class="hljs-keyword">add</span> name=vlan_2_e2 <span class="hljs-keyword">interface</span>=ether2 vlan-id=<span class="hljs-number">2</span><br />/<span class="hljs-keyword">interface</span> bridge port<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=vlan_1_e1 bridge=bridge_vlan1<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=vlan_1_e2 bridge=bridge_vlan1<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=vlan_2_e1 bridge=bridge_vlan2<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=vlan_2_e2 bridge=bridge_vlan2</code></pre> <p>Para ser honesto, aunque es una configuración un poco más complicada es mi método preferido cuando hay más de una vlan que tiene que pasar a través del mismo router. La principal razón por la que prefiero este método es porque permite ver en la lista de interfaces cuanto tráfico está pasando por cada vlan.</p> <p>Un inspección rápida del código debería permitir entender cómo funciona; Primero, creamos los bridges que dejan pasar el tráfico de cada vlan. Después, se crean los interfaces vlan en cada puerto ethernet físico. En la última sección, añadimos las vlan al bridge dejando pasar el tráfico <strong>CON EL TAG CORRECTO</strong> a través del router. Esto debería estar claro si aplicamos la primera premisa de que </p> <blockquote>  <p>cada vez que un paquete deja el router POR UN INTERFACE VLAN, queda marcado con esa vlan. <br>  Examine con atención la imagen y será capaz de ver qué interface será usado para transportar el tráfico hacia dentro y hacia fuera del router.</p></blockquote> <p>Les ofrezco una última configuración bastante usada. Aquí está la imagen: <br><img src="https://dl.dropboxusercontent.com/u/70868298/vlan_tag_untag2.png" alt="vlan-untag" title=""></p> <p>En esta red, tenemos paquetes marcados que entran al router por ether1 (vlan-id=1) y paquetes sin marcar entrando por ether2. Los dispositivos en la red sin marcar no usarán marcas de vlan (de hecho nunca sabrán que hay una configuración de vlan implicada en la red). Todos los dispositivos de la parte izquierda del router Mikrotik usarán tags vlan. Aquí está el código de configuración:</p>   <pre class="prettyprint"><code class=" hljs oxygene">/<span class="hljs-keyword">interface</span> vlan<br /><span class="hljs-keyword">add</span> name=vlan_1_e1 <span class="hljs-keyword">interface</span>=ether1 vlan-id=<span class="hljs-number">1</span><br />/<span class="hljs-keyword">interface</span> bridge<br /><span class="hljs-keyword">add</span> name=bridge1<br />/<span class="hljs-keyword">interface</span> bridge port<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=vlan_1_e1 bridge=bridge1<br /><span class="hljs-keyword">add</span> <span class="hljs-keyword">interface</span>=ether2 bridge=bridge1</code></pre> <p>Esta es una configuración bastante sencilla, pero requiere alguna explicación. Primero creamos un interface vlan en ether1, que estará conectado en la red marcada. Después, creamos un bridge para manejar el tráfico que pasa a través. El interface vlan se añade al bridge <strong>y</strong> al puerto físico ether2 que se añade a él. El puerto ether2 se conectará a la red sin marcar. Se deja como ejercicio a mis lectores determinar POR QUÉ esta configuración causa que salgan tanto paquetes marcados cómo sin marcar cuando salen del router.</p> <p>Este es un artículo bastante largo que cubre mucha información. Por razones obvias, no podemos cubrir el 100% de las posibilidades de configuración de red existentes pero he intentado cubrir las más comunes. Espero que este artículo les sea de utilidad y profundicen más en otros de mi sitio web. Siéntase libre de añadir sus comentarios o circunstáncias especiales y cómo las ha solucionado. Si necesita hardware asegúrese de entrar en mi tienda en <a href="http://store.wispgear.net/">http://store.wispgear.net/</a>.</p>