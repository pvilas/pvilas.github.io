---
layout: post
title: Campos calculados en django
date: '2012-10-17T16:53:00.005+02:00'
author: Pere Vilas
tags:
- django
- python
modified_time: '2012-10-17T17:03:11.589+02:00'
blogger_id: tag:blogger.com,1999:blog-9191328551308072706.post-6970747098471921055
blogger_orig_url: http://www.pvilas.com/2012/10/campos-calculados-en-django.html
---

Las operaciones sobre los objetos model de django se mapean a SQL mediante el ORM (Object-relational mapping). Un problema que tiene el ORM de django es que no tiene soporte directo para los campos calculados, que son aquellos que se obtienen a partir de los valores de los campos del registro para cada registro.<br /><br />Por ejemplo, tenemos unos movimientos en los que interviene cantidad, precio y comisión. ¿Qué sentido tiene guardar en la BD el campo importe si en realidad ya tenemos toda la información para calcularlo?.<br /><pre class=""><code><br />class Movimiento(models.Model):<br />&nbsp; &nbsp;cantidad=models.DecimalField()<br />&nbsp; &nbsp;precio=models.DecimalField()<br />&nbsp; &nbsp;comision=models.DecimalField()<br /></code></pre><br />¿Cómo calculamos entonces el importe?. Hay dos alternativas: Una usando una property de python en el propio objeto model y otra usando extra en el queryset. Veamos: <br /><pre class=""><code><br />class Movimiento(models.Model):<br />&nbsp; &nbsp;cantidad=models.DecimalField()<br />&nbsp; &nbsp;precio=models.DecimalField()<br />&nbsp; &nbsp;comision=models.DecimalField()<br /><b><br />&nbsp; &nbsp;def _get_importe(self):<br />&nbsp; &nbsp;&nbsp; &nbsp;return self.cantidad*self.cambio*(1-self.comision)<br />&nbsp; &nbsp;importe = property(_get_importe)<br /></b><br /></code></pre>Y ahí tenemos el importe del movimiento via movimiento.importe<br /><br />La otra solución es usar extra en el queryset para añadir "a mano" el campo en la consulta SQL, sería:  <br /><pre class=""><code><br />target=movimiento.objects.extra(select={<br />          'importe': 'cantidad*cambio*(1-comision)',})<br />for f in target:<br />    print f.importe<br /></code></pre><br />Entonces, ¿Cuál es el problema?. Pues que todo esto son soluciones "de mentirijilla" puesto que realmente el campo importe no existe como tal en el gestor de BD y no podemos hacer cosas como sumar todos los importes haciendo una agregación, así esto<br /><pre class=""><code><br />total_importe=modelo.aggregate(Sum('importe'))<br /></code></pre><br />Nos genera un error diciendo que el campo importe no existe.<br /><br />Sin duda, el soporte para campos calculados es uno de las mejoras del ORM que puede trabajarse.<br /><br /><br /><span style="font-size: x-small;">Fuentes:</span><br /><a href="http://stackoverflow.com/questions/3690343/django-orm-equivalent-for-this-sql-calculated-field-derived-from-related-table"><span style="font-size: x-small;">http://stackoverflow.com/questions/3690343/django-orm-equivalent-for-this-sql-calculated-field-derived-from-related-table</span></a>