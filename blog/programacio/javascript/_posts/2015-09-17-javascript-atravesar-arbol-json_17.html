---
layout: post
title: Javascript atravesar árbol JSON
date: '2015-09-17T02:00:00.001+02:00'
author: Pere Vilas
tags:
- javascript
modified_time: '2015-09-17T12:20:13.430+02:00'
blogger_id: tag:blogger.com,1999:blog-9191328551308072706.post-4291130395354011711
blogger_orig_url: http://www.pvilas.com/2015/09/javascript-atravesar-arbol-json_17.html
---

<h3 id="el-problema">El problema</h3> <p>Tenemos el árbol de menú de una aplicación. Cada hoja tiene unos permisos asociados. Sólo queremos mostrar los nodos de los que el usuario tenga algún permiso.</p> <p>Una posible forma de hacerlo es recorrer el árbol una vez y acumular en los nodos los permisos del nivel por debajo. El recorrido sería en postorden.</p> <p>Los usuarios tienen grupos de permisos (roles). En el momento de generar el menú de un usuario particular, deberemos volver a recorrer el árbol, esta vez en anchura (por niveles), tomando sólo aquellos nodos que tengan algún permiso coincidente. Si no hay ninguno, no es necesario bajar al siguiente nivel de esa rama.</p> <h3 id="árbol-de-menús">Árbol de menús</h3>   <pre class="prettyprint"><code class="language-javascript hljs "><span class="hljs-keyword">var</span> modulos = [<br /><br /><br />    {permiso: [], descripcion: <span class="hljs-string">'Almacenes'</span>, url: <span class="hljs-string">'#'</span>,<br />        submenus: [<br />            {permiso: [<span class="hljs-string">'compras.alb.ver'</span>], descripcion: <span class="hljs-string">'Artículos'</span>,   url: <span class="hljs-string">'/app/articulos'</span>},<br />            {permiso: [<span class="hljs-string">'compras.prov.ver'</span>], descripcion: <span class="hljs-string">'Proveedores'</span>, url: <span class="hljs-string">'/app/proveedores'</span>},<br />            {permiso: [<span class="hljs-string">'alm.inv.ver'</span>], descripcion: <span class="hljs-string">'Inventario'</span>,  url: <span class="hljs-string">'/app/inventario'</span>},<br />            {permiso: [<span class="hljs-string">'alm.edit'</span>], descripcion: <span class="hljs-string">'Almacenes'</span>,   url: <span class="hljs-string">'/app/almacenes'</span>}<br />        ]<br />    },<br /><br />    {permiso: [], descripcion: <span class="hljs-string">'Compras'</span>, url: <span class="hljs-string">'#'</span>,<br />        submenus: [<br />            {permiso: [<span class="hljs-string">'compras.pedidos.ver'</span>], descripcion: <span class="hljs-string">'Pedidos'</span>, url: <span class="hljs-string">'/app/compras/pedidos'</span>},<br />            {permiso: [<span class="hljs-string">'compras.albaranes.ver'</span>], descripcion: <span class="hljs-string">'Albaranes'</span>, url: <span class="hljs-string">'/app/compras/albaranes'</span>, <br />            submenus: [<br />             {permiso: [<span class="hljs-string">'compras.alb.edt'</span>], descripcion: <span class="hljs-string">'Editar'</span>,   url: <span class="hljs-string">'/app/albaranes/edit'</span>},<br />            {permiso: [<span class="hljs-string">'compras.alb.lst'</span>], descripcion: <span class="hljs-string">'Listar'</span>, url: <span class="hljs-string">'/app/albaranes/list'</span>},<br />            ]},<br />        ]<br />    },<br />];</code></pre> <p>El nodo <strong>Almacenes</strong> debería contener los permisos de los que tiene por debajo, el nodo <strong>Albaranes</strong> debería contener [<em>compras.alb.edt</em>, <em>compras.alb.lst</em>] y el nodo <strong>Compras</strong> [<em>compras.pedidos.ver</em>, <em>compras.albaranes.ver</em>, <em>compras.alb.edt</em>, <em>compras.alb.lst</em>].</p>   <h3 id="recorrido-de-un-árbol-json-en-postorden">Recorrido de un árbol JSON en postorden</h3> <p>Observamos que tenemos tanto <em>objects</em> como <em>arrays</em>: Atravesamos los arrays con <strong>forEach</strong> y los objetos examinando sus claves con <strong>for (var key in obj) </strong>. Bajamos hasta la primera hoja de la izquierda, visitando las hermanas para subir después al nodo superior. El proceso se repite de forma recursiva hasta haber visitado todos los nodos. Mantenemos la referencia al nodo inmediatamente superior con parent para poder acumular en él los permisos.</p> <pre class="prettyprint"><code class="language-javascript hljs "><span class="hljs-keyword">var</span> _und = <span class="hljs-built_in">require</span>(<span class="hljs-string">"underscore"</span>);<br /><br /><span class="hljs-comment">// último nodo visitado</span><br /><span class="hljs-keyword">var</span> lastObject=<span class="hljs-literal">null</span>;<br /><br /><span class="hljs-comment">/** <br />* Atraviesa un arbol JSON en postorden<br />* @param x - el nodo actual<br />* @param level - sólo para debug, caracter para imprimir delante de los nodos<br />* @parent - referencia al nodo padre o null<br />*/</span><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">traverse</span><span class="hljs-params">(x, level, parent)</span> {</span><br />    <span class="hljs-keyword">if</span> (isArray(x)) {<br />        traverseArray(x, level, parent);<br />    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'object'</span>) &amp;&amp; (x !== <span class="hljs-literal">null</span>)) {<br />        traverseObject(x, level, parent);<br />    } <span class="hljs-keyword">else</span> {<br />        <span class="hljs-comment">// tipus primitiu</span><br />    }<br />}<br /><br /><span class="hljs-comment">/**<br />* Determina si el tipo es array<br />* @param o - el objeto javascript<br />* @return true si es un aray<br />*/</span><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isArray</span><span class="hljs-params">(o)</span> {</span><br />    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(o) === <span class="hljs-string">'[object Array]'</span>;<br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">traverseArray</span><span class="hljs-params">(arr, level, parent)</span> {</span><br />    arr.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span> {</span><br />        traverse(x, level + <span class="hljs-string">"  "</span>, parent);<br />    });<br />    <span class="hljs-comment">//console.log(level + "&lt;array&gt;");</span><br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">traverseObject</span><span class="hljs-params">(obj, level, parent)</span> {</span><br />    <span class="hljs-comment">//console.log(level + "&lt;object&gt;");</span><br /><br />    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) {<br />        <span class="hljs-keyword">if</span> (obj.hasOwnProperty(key)) {<br />            lastObj=parent<br />            traverse(obj[key], level + <span class="hljs-string">"    "</span>, obj);<br />        }<br />    }<br /><br />    <span class="hljs-comment">// Acumulamos los permisos en el padre</span><br />    <span class="hljs-comment">// usamos _und.union para evitar permisos duplicados</span><br />    <span class="hljs-keyword">if</span> (obj &amp;&amp; obj.descripcion) {<br />        <span class="hljs-keyword">var</span> p=<span class="hljs-string">''</span><br />        <span class="hljs-keyword">if</span> (parent) {<br />            p=parent.descripcion           <br />            parent.permiso=_und.union(parent.permiso, obj.permiso)<br />        } <span class="hljs-keyword">else</span> {<br />            p=<span class="hljs-string">'/'</span><br />        }<br />        console.log(<span class="hljs-string">'visitant'</span>, obj.descripcion,<span class="hljs-string">'amb pare'</span>, p);<br />    }<br />}</code></pre> <p>Ahora ya sólo queda hacer</p>   <pre class="prettyprint"><code class="language-javascript hljs ">traverse(modulos, <span class="hljs-string">''</span>)</code></pre> <p>Para mostrar los menús, podemos poner una marca de visibilidad y enviar el árbol al renderizador de plantillas que sólo mostrará los que tengan visible==true.</p>   <pre class="prettyprint"><code class="language-javascript hljs "><span class="hljs-keyword">var</span> recurseMenus= <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(permisos, m)</span> {</span><br />    _und.each(m, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(md)</span> {</span><br />        <span class="hljs-comment">//logger.debug('mirant si menu', md.descripcion, 'te el permís', md.permiso)</span><br />        <span class="hljs-comment">// hacemos la intersección del conjunto de permisos del usuario con los del nodo actual</span><br />        <span class="hljs-keyword">var</span> interseccio=_und.intersection(md.permiso, permisos)<br />        <span class="hljs-comment">// si el resultado de la intersección es diferente del conjunto vacío el usuario puede ver este menú</span><br />        <span class="hljs-keyword">if</span> (_und.size(interseccio)&gt;<span class="hljs-number">0</span>) {<br />            <span class="hljs-comment">//logger.debug('te permis de ', md.permiso)</span><br />            md.visible=<span class="hljs-literal">true</span><br />            <span class="hljs-keyword">if</span> (md.submenus) {<br />                recurseMenus(permisos, md.submenus)<br />            }<br />        } <span class="hljs-keyword">else</span> {<br />            <span class="hljs-comment">//logger.debug('no te el permis')</span><br />            md.visible = <span class="hljs-literal">false</span>;<br />        }<br />    })<br />}<br /></code></pre> <h3 id="referencias">Referencias</h3> <p><a href="https://www.quora.com/How-do-you-loop-through-a-complex-JSON-tree-of-objects-and-arrays-in-JavaScript">https://www.quora.com/How-do-you-loop-through-a-complex-JSON-tree-of-objects-and-arrays-in-JavaScript</a></p>